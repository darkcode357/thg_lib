# STATIC ANALYSIS BASICS

## Mount live Sysinternats toots drive:
```
\\live.sysinternals.com\tools
Signature check of dlt, exe files:
Ref. http://technet.microsoft.com/enus/sysinternals/bb897441.aspx
C:\> sigcheck.exe -u -e (:\<DIRECTORY>
```
## Send to VirusTotat:
```
C:\> sigcheck.exe -vt <SUSPICIOUS FILE NAME>
```
# Windows PE Analysis:

## View Hex and ASCI of PE{exe or any file), with optional -n first 500 bytes:
```
# hexdump -C -n 500 <SUSPICIOUS FILE NAME>
# od -x somefile.exe
# xxd somefile.exe
```
## In Windows using debug toot {works for .java files too):
```
C:\> debug <SUSPICIOUS FILE NAME>
 -d (just type d and get a page at a time of hex)
 -q (quit debugger)
```
## Windows PE analysis:
```
PE Fite Compile Date/Time pert script below (Windows
PE only script).
Ref. https://www.perl.org/get.html
Ref. http://www.perlmonks.org/bare/?node_id=484287

C:\> perl.exe <SCRIPT NAME>.pl <SUSPICIOUS FILENAME>
#! perl -slw
use strict;
open EXE, '<:raw', $ARGV[0] or die "$ARGV[0]
my $dos = do{ local$/ = \65536; <EXE>};
$1" •
. ,
die "$ARGV[0] is not a .exe or .dll (sig='${ \substr
$dos, 0, 2 } ')" unless substr( $dos, 0, 2 ) eq 'MZ';
my $coffoff = 8+ unpack 'x60 V', $dos;
read( EXE, $dos, $coffoff - 65536 + 4, 65536 ) or
die$! if $coffoff > 65536;
my $ts = unpack "x$coffoff V", $dos;
print "$ARGV [0] : ", defined $ts
? ( scalar( localtime $ts) 11 "has unfathomable
timestamp value $ts" )
: 'has no timestamp';
_END_
```
# View strings within PE and optional string length -n option:
## Using stings in Linux:
```
strings -n 10 <SUSPICIOUS FILE NAME>
Ref. https://technet.microsoft.com/enus/sysinternals/strings.aspx

Using strings in Windows:
C:\> strings <SUSPICIOUS FILE NAME>
```
## Find Malware in memory dump using Volatility and Windows7SPFix64 profile:
```
![Ref](https://github.com/volatilityfoundation/volatility]
python vol.py -f <MEMORY DUMP FILE NAME>.raw -profile=Win7SPFix64 malfind -D /<OUTPUT DUMPDIRECTORY>
```
## Find Malware with PID in memory dump usingVolatility:
```
python vol.py -f <MEMORY DUMP FILE NAME>.raw -profile=Win7SPFix64 malfind -p <PID #> -D /<OUTPUTDUMP DIRECTORY>
```
## Find suspicious processes using Volatility:
```
python vol.py -f <MEMORY DUMP FILE NAME>.raw -profile=Win7SPFix64 pslist
python vol.py -f <MEMORY DUMP FILE NAME>,raw -profile=Win7SPFix64 pstree
```
## Find suspicious dlls using Volatility:
```
python vol.py -f <MEMORY DUMP FILE NAME>.raw -profile=Win7SPFix64 dlllist
python vol.py -f <MEMORY DUMP FILE NAME>.raw -profile=Win7SPFix64 dlldump -D /<OUTPUT DUMPDIRECTORY>
```
## Malware analysis parsing Tool:
```
Ref. https://github.com/Defense-Cyber-CrimeCenter/DC3-MWCP
```
## Install dc3-mwcp tool:
```
# setup.py install
Use dc3-mwcp tool to parse suspicious file:
# mwcp-tool.py -p <SUSPICIOUS FILE NAME>
```

# PROCESS EXPLORER

## Step 1: Look at running processes by running Process Explorer (GUI) and identify potential indicators of compromise:
```
* Items with no icon

* Items with no description or company name

* Unsigned Microsoft images (First add Verified
  Signer column under View tab->Select Columns,
  then go to Options tab and choose Verify Image Signatures)

* Check all running process hashes in Virus Total (Go to Options tab and select Check VirusTota l. com)

* Suspicious files are in Windows directories or user profile

* Purple items that are packed or compressed

* Items with open TCP/IP endpoints
```

## Step 2: Signature File Check:
```
( See Sigcheck)
```
## Step 3: Strings Check:
```
• Right click on suspicious process in Process
  Explorer and on pop up window choose Strings tab
  and review for suspicious URLs. Repeat for Image
  and Memory radio buttons.

• Look for strange URLs in strings
```
## Step 4: DLL View:
```
• Pop open with Ct rl+D

• Look for suspicious DLLs or services

• Look for no description or no company name

• Look at VirusTotal Results column
```

## Step 5: Stop and Remove Malware:
```
• Right click and select Suspend for any identified suspicious processes
• Right click and select Terminate Previous Suspended processes
```
## Step 6: Clean up where malicious files Auto start on reboot.
```
• Launch Autoruns
• Under Options, Check the boxes Verify Code
  Signatures and Hide Microsoft entries
• Look for suspicious process file from earlier
  steps on the everything tab and uncheck. Safer to
  uncheck than delete, in case of error.
• Press FS, to refresh Autoruns, and confirm
  malicious file has not recreated the malicious
  entry into the previous unchecked auto start
  location.
```
## Step 7: Process Monitor
![Ref](https://technet.microsoft.com/enus/sysinternals/processmonitor.aspx)
```
• If malicious activity is still persistent, run
  Process Monitor.

• Look for newly started process that start soon
  after terminated from previous steps.
```
## Step 8: Repeat as needed to find all malicious files and process and/or combine with other tools and suites.

# FILE HASH ANALYSIS

# HASH QUERY
## VirusTotal online API query:
```
![Ref](https://www.virustotal.com/en/documentation/publicapi/)
(Prerequisite: Need a VT API Key)
```
## Send a suspicious hash to VirtusTotal using cURL:
```
curl -v --request POST --url https://www.virustotal.com/vtapi/v2/file/report' -d apikey=<VT API KEY> -d 'resource=<SUSPICIOUS FILEHASH>'
```
## Send a suspicious file to VirusTotal using cURL:
```
# curl -v -F 'file=/<PATH TO FILE>/<SUSPICIOUS FILENAME>' -F apikey=<VT API KEY> https://www.virustotal.com/vtapi/v2/file/scan
```

## Team Cymru API:
```
Ref. https://hash.cymru.com, http://totalhash.com
Team Cymru malware hash lookup using whois: (Note:
Output is timestamp of last seen and detection rate)
# whois -h hash,cymru.com <SUSPICIOUS FILE HASH>
```

# HARD DRIVE AND MEMORY ACQUISITION
## WINDOWS
## Create memory dump remotely:
```
Ref. http://kromer.pl/malware-analysis/memoryforensics-using-volatility-toolkit-to-extractmalware-samples-from-memory-dump/
Ref. http://sourceforge.net/projects/mdd/
Ref. https://technet.microsoft.com/enus/sysinternals/psexec.aspx

C: \> psexec. exe \\<HOST NAME OR IP ADDRESS> -u <DOMAIN>\<PRIVILEGED ACCOUNT> -p <PASSWORD> -cmdd_l,3.exe --o C:\memory.dmp
Ref.https://github.com/volatilityfoundation/volatility
```
## Extract exe/dll from memory dump:
```
C:\> volatility dlldump -f memory.dmp -0 dumps/
C:\> volatility procmemdump -f memory.dmp -0 dumps/
```
## Create hard drive image using dc3dd of C:\:
```
Ref.https://sourceforge.net/projects/dc3dd/files/dc3dd/7.2%20-%20Windows/
C:\> dc3dd,exe if=\\,\c: of=d:\<ATTACHED OR TARGETDRIVE>\<IMAGE NAME>,dd hash=md5 log=d:\<MOUNTEDLOCATION>\<LOG NAME>, log
```

# LINUX
## Create memory dump:
```
dd if=/dev/fmem of=/tmp/<MEMORY FILE NAME>.dd
```
## Create memory dump using LiME:
```
Ref. https://github.com/504ensicslabs/lime

wgethttps://github.com/504ensicslabs/LiME/archive/master.zip

unzip master.zip

cd LiME-master/src

make

p lime-*,ko /media/=/media/ExternalUSBDriveName/

insmod lime-3.13.0-79-generic.ko

"path=/media/Exte rna lUSBDriveName/<MEMORY DUMP>, limeformat=raw"
```
## Make copy of suspicious process using process ID:
```
cp /proc/<SUSPICIOUS PROCESS ID>/exe /<NEW SAVEDLOCATION>
```
## Grab memory core dump of suspicious process:
```
gcore <PIO>
```
## Strings on gcore file:
```
# strings gcore.*
```
## Create a hard drive/partition copy with tog and hash options:
```
dd if=<INPUT DEVICE> of=<IMAGE FILE NAME>
dc3dd if=/dev/<TARGET DRIVE EXAMPLE SDA OR SDAl> of=/dev/<MOUNTED LOCATION>\<FILE NAME>.img hash=md5 log=/<MOUNTED LOCATION>/<LOG NAME>.log
```

## Create a remote hard drive/partition over SSH:
```
dd if=/dev/<INPUT DEVICE> I ssh <USERNAME>@<DESTINATION IP ADDRESS> "dd of=<DESTINATIONPATH>"
```

# Send hard drive image zipped over netcat:
## Sending host:
```
bzip2 -c /dev/<INPUT DEVICE> I nc <DESTINATION IPADDRESS> <PICK A PORT>
```
## Receiving host:
```
nc -p <PICK SAME PORT> -l lbzip2 -d I dd of=/dev/sdb
```
# Send hard drive image over netcat:
## Sending host:
```
dd if=/dev/<INPUT DEVICE> bs=16M I nc <PORT>
```
## Receiving host with Pipe Viewer meter:
```
nc -p <SAME PORT> -l -vv I pv -r I dd of=/dev/<INPUT DEVICE> bs=16M
```